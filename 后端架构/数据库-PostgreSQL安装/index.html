<!doctype html><html class=no-js lang=zh-cn><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>å…¸ç±ç¯‡</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="å¼€æºæ–‡æ¡£å…¸ç±ç¯‡æ±‡æ€»"><meta name=generator content="Hugo 0.152.2"><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/quiz.css><link rel="shortcut icon" href=/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a class=logo__link href=/ title=è¡¥æ¼ç –åŒ  rel=home><div class=logo__title>è¡¥æ¼ç –åŒ </div><div class=logo__tagline>ç‹¬é’“å¯’æ±Ÿé›ªï¼Œä¸ºæœ‰æš—é¦™æ¥ã€‚</div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>èœå•</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-%E5%89%91%E6%B3%95%E7%AF%87/>ç¼–ç¨‹è¯­è¨€</a></li><li class=menu__item><a class=menu__link href=/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2-%E6%9C%BA%E5%85%B3%E7%AF%87/>è¿ç»´éƒ¨ç½²</a></li><li class=menu__item><a class=menu__link href=/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E7%AE%97%E6%B3%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-%E6%A3%8B%E8%B0%B1%E7%AF%87/>ç®—æ³•æ•°æ®ç»“æ„</a></li><li class=menu__item><a class=menu__link href=/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84-%E5%85%B5%E6%B3%95%E7%AF%87/>åç«¯æ¶æ„</a></li><li class=menu__item><a class=menu__link href=/%E5%B7%A5%E5%85%B7%E6%95%88%E7%8E%87/%E5%B7%A5%E5%85%B7%E6%95%88%E7%8E%87-%E6%B3%95%E5%AE%9D%E7%AF%87/>å·¥å…·æ•ˆç‡</a></li><li class=menu__item><a class=menu__link href=/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91-%E7%94%BB%E5%8D%B7%E7%AF%87/>å‰ç«¯å¼€å‘</a></li><li class=menu__item><a class=menu__link href=/%E5%BC%80%E6%BA%90%E6%96%87%E6%A1%A3/%E5%BC%80%E6%BA%90%E6%96%87%E6%A1%A3-%E5%85%B8%E7%B1%8D%E7%AF%87/>å¼€æºæ–‡æ¡£</a></li><li class=menu__item><a class=menu__link href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-AI%E5%9C%A8%E7%BA%BF%E6%B5%8B%E8%AF%95/>JAVAåœ¨çº¿æµ‹è¯•</a></li><li class=menu__item><a class=menu__link href=/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80-%E5%9C%A8%E7%BA%BF%E7%AD%94%E9%A2%98%E7%A4%BA%E4%BE%8B/>åœ¨çº¿ç­”é¢˜</a></li><li class=menu__item><a class=menu__link href=/%E5%B7%A5%E5%85%B7%E6%95%88%E7%8E%87/%E5%B7%A5%E5%85%B7%E6%95%88%E7%8E%87-DeepSeek%E6%B5%81%E5%BC%8F%E8%81%8A%E5%A4%A9/>DeepSeek</a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>å…¸ç±ç¯‡</h1><p class=post__lead>èšç¤¾åŒºä¹‹æ™ºï¼Œä¼ æŠ€æœ¯ä¹‹ç«</p><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-3e-7c-4.4.0-8 3.6-8 8C0 12.4 3.6 16 8 16s8-3.6 8-8.0000003c0-4.4-3.6-8-8-8zM8 14.4c-3.52.0-6.4-2.88-6.4-6.4000003.0-3.52 2.88-6.4 6.4-6.4s6.4 2.88 6.4 6.4C14.4 11.52 11.52 14.4 8 14.4zm.4-10.4000003H7.2v4.8L11.36 11.36l.64-1.04-3.6-2.1600003z"/></svg>
<time class=meta__text datetime=2025-11-27T00:00:00>November 27, 2025</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg>
<span class=meta__text><a class=meta__link href=/categories/%e5%bc%80%e6%ba%90%e6%96%87%e6%a1%a3 rel=category>å¼€æºæ–‡æ¡£</a></span></div></div></header><div class="content post__content clearfix"><p><a href=/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84-%E5%85%B5%E6%B3%95%E7%AF%87/>â—€ è¿”å›</a></p><h1 id=æºç å®‰è£…postgresqlç¨³å®šç‰ˆæœ¬linux>æºç å®‰è£…PostgreSQLç¨³å®šç‰ˆæœ¬ï¼ˆLinuxï¼‰</h1><h2 id=-å‡†å¤‡å·¥ä½œ>ğŸ“‹ å‡†å¤‡å·¥ä½œ</h2><h3 id=1-æŸ¥çœ‹æœ€æ–°ç¨³å®šç‰ˆæœ¬>1. <strong>æŸ¥çœ‹æœ€æ–°ç¨³å®šç‰ˆæœ¬</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è®¿é—®PostgreSQLå®˜ç½‘æˆ–ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹</span>
</span></span><span style=display:flex><span>curl -s https://www.postgresql.org/ftp/source/ | grep -E <span style=color:#e6db74>&#39;href=&#34;v[0-9]+\.[0-9]+/&#34;&#39;</span> | tail -5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å½“å‰é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼ˆLTSï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># PostgreSQL 16.x (æœ€æ–°ç¨³å®šç‰ˆ)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># PostgreSQL 15.x (é•¿æœŸæ”¯æŒ)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># PostgreSQL 14.x (é•¿æœŸæ”¯æŒåˆ°2026å¹´)</span>
</span></span><span style=display:flex><span><span style=color:#75715e># PostgreSQL 13.x (é•¿æœŸæ”¯æŒåˆ°2025å¹´)</span>
</span></span></code></pre></div><h3 id=2-å®‰è£…ç¼–è¯‘ä¾èµ–>2. <strong>å®‰è£…ç¼–è¯‘ä¾èµ–</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Ubuntu/Debian</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>sudo apt install -y <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    build-essential <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libreadline-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    zlib1g-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    flex bison <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxml2-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxslt-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libssl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libssl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libpam0g-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libldap-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libperl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libicu-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tcl-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    python3-dev <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    wget <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    curl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># CentOS/RHEL/Rocky/AlmaLinux</span>
</span></span><span style=display:flex><span>sudo yum groupinstall -y <span style=color:#e6db74>&#34;Development Tools&#34;</span>
</span></span><span style=display:flex><span>sudo yum install -y <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    readline-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    zlib-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    flex bison <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxml2-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    libxslt-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    openssl-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    pam-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    openldap-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    perl-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    perl-ExtUtils-Embed <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    tcl-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    python3-devel <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    wget
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vi /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=color:#75715e>#æœ€å¤§å…±äº«å†…å­˜æ®µå¤§å°</span>
</span></span><span style=display:flex><span>kernel.shmmax <span style=color:#f92672>=</span> 68719476736<span style=color:#f92672>(</span>é»˜è®¤<span style=color:#f92672>)</span> 
</span></span><span style=display:flex><span> <span style=color:#75715e>#å¯ä»¥ä½¿ç”¨çš„å…±äº«å†…å­˜çš„æ€»é‡</span>
</span></span><span style=display:flex><span>kernel.shmall <span style=color:#f92672>=</span> 4294967296<span style=color:#f92672>(</span>é»˜è®¤<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#æ•´ä¸ªç³»ç»Ÿå…±äº«å†…å­˜æ®µçš„æœ€å¤§æ•°ç›®</span>
</span></span><span style=display:flex><span>kernel.shmmni <span style=color:#f92672>=</span> <span style=color:#ae81ff>4096</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#æ¯ä¸ªä¿¡å·å¯¹è±¡é›†çš„æœ€å¤§ä¿¡å·å¯¹è±¡æ•°</span>
</span></span><span style=display:flex><span>kernel.sem <span style=color:#f92672>=</span> <span style=color:#ae81ff>50100</span> <span style=color:#ae81ff>64128000</span> <span style=color:#ae81ff>50100</span> <span style=color:#ae81ff>1280</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#æ–‡ä»¶å¥æŸ„çš„æœ€å¤§æ•°é‡ã€‚</span>
</span></span><span style=display:flex><span>fs.file-max <span style=color:#f92672>=</span> <span style=color:#ae81ff>7672460</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#åº”ç”¨ç¨‹åºå¯ä½¿ç”¨çš„IPv4ç«¯å£èŒƒå›´</span>
</span></span><span style=display:flex><span>net.ipv4.ip_local_port_range <span style=color:#f92672>=</span> <span style=color:#ae81ff>9000</span> <span style=color:#ae81ff>65000</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#å¥—æ¥å­—æ¥æ”¶ç¼“å†²åŒºå¤§å°çš„ç¼ºçœå€¼</span>
</span></span><span style=display:flex><span>net.core.rmem_default <span style=color:#f92672>=</span> <span style=color:#ae81ff>1048576</span> 
</span></span><span style=display:flex><span><span style=color:#75715e>#å¥—æ¥å­—å‘é€ç¼“å†²åŒºå¤§å°çš„ç¼ºçœ</span>
</span></span><span style=display:flex><span>net.core.wmem_default <span style=color:#f92672>=</span> <span style=color:#ae81ff>262144</span> å€¼
</span></span><span style=display:flex><span><span style=color:#75715e>#å¥—æ¥å­—å‘é€ç¼“å†²åŒºå¤§å°çš„æœ€å¤§å€¼</span>
</span></span><span style=display:flex><span>net.core.wmem_max <span style=color:#f92672>=</span> <span style=color:#ae81ff>1048576</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sysctl -p #é…ç½®ç”Ÿæ•ˆ</span>
</span></span></code></pre></div><h2 id=-æºç å®‰è£…postgresql-162å½“å‰ç¨³å®šç‰ˆ>ğŸš€ æºç å®‰è£…PostgreSQL 16.2ï¼ˆå½“å‰ç¨³å®šç‰ˆï¼‰</h2><h3 id=æ­¥éª¤1åˆ›å»ºä¸“ç”¨ç”¨æˆ·å’Œç›®å½•>æ­¥éª¤1ï¼šåˆ›å»ºä¸“ç”¨ç”¨æˆ·å’Œç›®å½•</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºpostgresç³»ç»Ÿç”¨æˆ·å’Œç»„</span>
</span></span><span style=display:flex><span>sudo groupadd -r postgres
</span></span><span style=display:flex><span>sudo useradd -r -g postgres -s /bin/bash -d /usr/local/pgsql -m -k /dev/null postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºå®‰è£…ç›®å½•å’Œæ•°æ®ç›®å½•</span>
</span></span><span style=display:flex><span>sudo mkdir -p /usr/local/pgsql/<span style=color:#f92672>{</span>data,logs,backup<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>sudo chown -R postgres:postgres /usr/local/pgsql
</span></span><span style=display:flex><span>sudo chmod <span style=color:#ae81ff>750</span> /usr/local/pgsql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæºç ç›®å½•</span>
</span></span><span style=display:flex><span>sudo mkdir -p /opt/postgresql_src
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>whoami<span style=color:#66d9ef>)</span> /opt/postgresql_src
</span></span><span style=display:flex><span>cd /opt/postgresql_src
</span></span></code></pre></div><h3 id=æ­¥éª¤2ä¸‹è½½æºç >æ­¥éª¤2ï¼šä¸‹è½½æºç </h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ä¸‹è½½PostgreSQL 16.2ï¼ˆæˆªè‡³2024å¹´3æœˆçš„æœ€æ–°ç¨³å®šç‰ˆï¼‰</span>
</span></span><span style=display:flex><span>wget https://ftp.postgresql.org/pub/source/v16.2/postgresql-16.2.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆ–è€…ä½¿ç”¨å›½å†…é•œåƒï¼ˆæ¸…åæºï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># wget https://mirrors.tuna.tsinghua.edu.cn/postgresql/source/v16.2/postgresql-16.2.tar.gz</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># éªŒè¯ä¸‹è½½å®Œæ•´æ€§ï¼ˆå¯é€‰ï¼‰</span>
</span></span><span style=display:flex><span>wget https://ftp.postgresql.org/pub/source/v16.2/postgresql-16.2.tar.gz.sha256
</span></span><span style=display:flex><span>sha256sum -c postgresql-16.2.tar.gz.sha256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è§£å‹æºç </span>
</span></span><span style=display:flex><span>tar -zxvf postgresql-16.2.tar.gz
</span></span><span style=display:flex><span>cd postgresql-16.2
</span></span></code></pre></div><h3 id=æ­¥éª¤3é…ç½®ç¼–è¯‘é€‰é¡¹>æ­¥éª¤3ï¼šé…ç½®ç¼–è¯‘é€‰é¡¹</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æ‰€æœ‰é…ç½®é€‰é¡¹</span>
</span></span><span style=display:flex><span>./configure --help
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç¼–è¯‘ç›®å½•ï¼ˆæ¨èï¼‰</span>
</span></span><span style=display:flex><span>mkdir build <span style=color:#f92672>&amp;&amp;</span> cd build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åŸºæœ¬é…ç½®ï¼ˆé€‚ç”¨äºå¤§å¤šæ•°æƒ…å†µï¼‰</span>
</span></span><span style=display:flex><span>../configure <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --prefix<span style=color:#f92672>=</span>/usr/local/pgsql <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-pgport<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-perl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-python <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-tcl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-openssl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-pam <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -with-uuid<span style=color:#f92672>=</span>ossp <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-ldap <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-libxml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-libxslt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-icu <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-thread-safety <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-debug <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-nls <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-system-tzdata<span style=color:#f92672>=</span>/usr/share/zoneinfo
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆ–è€…ç²¾ç®€é…ç½®ï¼ˆæœ€å°åŒ–å®‰è£…ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ../configure --prefix=/usr/local/pgsql --with-openssl</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤4ç¼–è¯‘å’Œå®‰è£…>æ­¥éª¤4ï¼šç¼–è¯‘å’Œå®‰è£…</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹CPUæ ¸å¿ƒæ•°ï¼Œå†³å®šå¹¶è¡Œç¼–è¯‘æ•°</span>
</span></span><span style=display:flex><span>nproc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¼–è¯‘ï¼ˆä½¿ç”¨4ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œæ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼‰</span>
</span></span><span style=display:flex><span>make -j4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¯é€‰ï¼šè¿è¡Œå›å½’æµ‹è¯•ï¼ˆéœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># make check</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…åˆ°ç³»ç»Ÿ</span>
</span></span><span style=display:flex><span>sudo make install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å®‰è£…contribæ¨¡å—ï¼ˆæ‰©å±•å·¥å…·ï¼‰</span>
</span></span><span style=display:flex><span>cd contrib
</span></span><span style=display:flex><span>make -j4
</span></span><span style=display:flex><span>sudo make install
</span></span><span style=display:flex><span>cd ..
</span></span></code></pre></div><h3 id=æ­¥éª¤5é…ç½®ç¯å¢ƒå˜é‡>æ­¥éª¤5ï¼šé…ç½®ç¯å¢ƒå˜é‡</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ä¸ºpostgresç”¨æˆ·é…ç½®ç¯å¢ƒå˜é‡</span>
</span></span><span style=display:flex><span>sudo tee -a /usr/local/pgsql/.bash_profile <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export PGHOME=/usr/local/pgsql
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export PGDATA=/usr/local/pgsql/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export PATH=$PGHOME/bin:$PATH
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export LD_LIBRARY_PATH=$PGHOME/lib:$LD_LIBRARY_PATH
</span></span></span><span style=display:flex><span><span style=color:#e6db74>export MANPATH=$PGHOME/share/man:$MANPATH
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¸ºå½“å‰ç”¨æˆ·é…ç½®ç¯å¢ƒå˜é‡</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#39;export PATH=/usr/local/pgsql/bin:$PATH&#39;</span> &gt;&gt; ~/.bashrc
</span></span><span style=display:flex><span>source ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># éªŒè¯å®‰è£…</span>
</span></span><span style=display:flex><span>/usr/local/pgsql/bin/postgres --version
</span></span></code></pre></div><h2 id=-åˆå§‹åŒ–æ•°æ®åº“å’Œé…ç½®>âš™ï¸ åˆå§‹åŒ–æ•°æ®åº“å’Œé…ç½®</h2><h3 id=æ­¥éª¤6åˆå§‹åŒ–æ•°æ®åº“>æ­¥éª¤6ï¼šåˆå§‹åŒ–æ•°æ®åº“</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ‡æ¢åˆ°postgresç”¨æˆ·</span>
</span></span><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆå§‹åŒ–æ•°æ®åº“é›†ç¾¤</span>
</span></span><span style=display:flex><span>initdb -D /usr/local/pgsql/data -E UTF8 --locale<span style=color:#f92672>=</span>C -U postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆ–è€…ä½¿ç”¨è¯¦ç»†å‚æ•°</span>
</span></span><span style=display:flex><span>initdb <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -D /usr/local/pgsql/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -E UTF8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --locale<span style=color:#f92672>=</span>en_US.UTF-8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --lc-collate<span style=color:#f92672>=</span>C <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --lc-ctype<span style=color:#f92672>=</span>en_US.UTF-8 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --username<span style=color:#f92672>=</span>postgres <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --pwprompt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¾ç½®å¯†ç ï¼ˆè®°ä¸‹è¿™ä¸ªå¯†ç ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¾“å…¥å¹¶ç¡®è®¤postgresç”¨æˆ·çš„å¯†ç </span>
</span></span></code></pre></div><h3 id=æ­¥éª¤7é…ç½®postgresqlconf>æ­¥éª¤7ï¼šé…ç½®postgresql.conf</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å¤‡ä»½åŸå§‹é…ç½®</span>
</span></span><span style=display:flex><span>cp /usr/local/pgsql/data/postgresql.conf /usr/local/pgsql/data/postgresql.conf.original
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç¼–è¾‘ä¸»é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>nano /usr/local/pgsql/data/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼ˆæ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>listen_addresses</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;*&#39;          # å…è®¸è¿œç¨‹è¿æ¥</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>5432                     # ç›‘å¬ç«¯å£</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_connections</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>100           # æœ€å¤§è¿æ¥æ•°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>shared_buffers</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>128MB          # å…±äº«ç¼“å†²åŒºå¤§å°ï¼ˆå»ºè®®ä¸ºå†…å­˜çš„25%ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>work_mem</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>4MB                  # æ¯ä¸ªæŸ¥è¯¢çš„å·¥ä½œå†…å­˜</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>maintenance_work_mem</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>64MB     # ç»´æŠ¤æ“ä½œçš„å†…å­˜</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dynamic_shared_memory_type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>posix  # åŠ¨æ€å…±äº«å†…å­˜ç±»å‹</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_level</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>replica             # WALçº§åˆ«</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>synchronous_commit</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on         # åŒæ­¥æäº¤</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_buffers</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>-1                # WALç¼“å†²åŒºï¼ˆ-1è¡¨ç¤ºè‡ªåŠ¨ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>checkpoint_timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>5min       # æ£€æŸ¥ç‚¹è¶…æ—¶æ—¶é—´</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_wal_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1GB              # æœ€å¤§WALå¤§å°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>min_wal_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>80MB             # æœ€å°WALå¤§å°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_mode</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>off              # å½’æ¡£æ¨¡å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_command</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/bin/date&#39;   # å½’æ¡£å‘½ä»¤ï¼ˆå…³é—­æ—¶éšæ„è®¾ç½®ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>logging_collector</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on          # å¯ç”¨æ—¥å¿—æ”¶é›†</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_directory</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pg_log&#39;        # æ—¥å¿—ç›®å½•</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_filename</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;postgresql-%Y-%m-%d_%H%M%S.log&#39;  # æ—¥å¿—æ–‡ä»¶åæ ¼å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_rotation_age</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1d           # æ—¥å¿—è½®è½¬æ—¶é—´</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_rotation_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10MB        # æ—¥å¿—è½®è½¬å¤§å°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_truncate_on_rotation</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on   # è½®è½¬æ—¶æˆªæ–­</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_line_prefix</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;%m [%p] %q%u@%d &#39;  # æ—¥å¿—å‰ç¼€</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>log_timezone</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Asia/Shanghai&#39;  # æ—¥å¿—æ—¶åŒº</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>timezone</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;Asia/Shanghai&#39;      # æ—¶åŒº</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>datestyle</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;iso, ymd&#39;          # æ—¥æœŸæ ¼å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lc_messages</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;en_US.UTF-8&#39;     # æ¶ˆæ¯è¯­è¨€</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lc_monetary</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;en_US.UTF-8&#39;     # è´§å¸æ ¼å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lc_numeric</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;en_US.UTF-8&#39;      # æ•°å­—æ ¼å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>lc_time</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;en_US.UTF-8&#39;         # æ—¶é—´æ ¼å¼</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>default_text_search_config</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;pg_catalog.english&#39;  # å…¨æ–‡æœç´¢é…ç½®</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤8é…ç½®å®¢æˆ·ç«¯è®¤è¯>æ­¥éª¤8ï¼šé…ç½®å®¢æˆ·ç«¯è®¤è¯</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ç¼–è¾‘pg_hba.conf</span>
</span></span><span style=display:flex><span>nano /usr/local/pgsql/data/pg_hba.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf># å…è®¸æœ¬åœ°è¿æ¥ï¼ˆmd5éœ€è¦å¯†ç ï¼Œtrustä¸éœ€è¦å¯†ç ï¼‰
local   all             postgres                                peer
local   all             all                                     md5
host    all             all             127.0.0.1/32            md5

# å…è®¸ç‰¹å®šIPæ®µè¿æ¥
host    all             all             192.168.1.0/24          md5

# å…è®¸æ‰€æœ‰IPè¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼‰
host    all             all             0.0.0.0/0               md5

# ç¤ºä¾‹ï¼šåªå…è®¸ç‰¹å®šç”¨æˆ·ä»ç‰¹å®šIPè®¿é—®ç‰¹å®šæ•°æ®åº“
# host    exam_db         app_user        192.168.1.100/32       md5
</code></pre><h3 id=æ­¥éª¤9åˆ›å»ºç³»ç»ŸæœåŠ¡>æ­¥éª¤9ï¼šåˆ›å»ºç³»ç»ŸæœåŠ¡</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é€€å‡ºpostgresç”¨æˆ·</span>
</span></span><span style=display:flex><span>exit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶</span>
</span></span><span style=display:flex><span>sudo tee /etc/systemd/system/postgresql.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=PostgreSQL Database Server
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Type=forking
</span></span></span><span style=display:flex><span><span style=color:#e6db74>User=postgres
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Group=postgres
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Environment=PGDATA=/usr/local/pgsql/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>OOMScoreAdjust=-1000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/usr/local/pgsql/bin/pg_ctl -D ${PGDATA} start
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStop=/usr/local/pgsql/bin/pg_ctl -D ${PGDATA} stop
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecReload=/usr/local/pgsql/bin/pg_ctl -D ${PGDATA} reload
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TimeoutSec=300
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æˆ–è€…ä½¿ç”¨simpleç±»å‹ï¼ˆæ¨èï¼‰</span>
</span></span><span style=display:flex><span>sudo tee /etc/systemd/system/postgresql.service <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Unit]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Description=PostgreSQL Database Server
</span></span></span><span style=display:flex><span><span style=color:#e6db74>After=network.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Service]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Type=simple
</span></span></span><span style=display:flex><span><span style=color:#e6db74>User=postgres
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Group=postgres
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Environment=PGDATA=/usr/local/pgsql/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Environment=PGPORT=5432
</span></span></span><span style=display:flex><span><span style=color:#e6db74>OOMScoreAdjust=-1000
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecStart=/usr/local/pgsql/bin/postgres -D ${PGDATA}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ExecReload=/bin/kill -HUP $MAINPID
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KillMode=mixed
</span></span></span><span style=display:flex><span><span style=color:#e6db74>KillSignal=SIGINT
</span></span></span><span style=display:flex><span><span style=color:#e6db74>TimeoutSec=300
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[Install]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WantedBy=multi-user.target
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤10å¯åŠ¨æœåŠ¡>æ­¥éª¤10ï¼šå¯åŠ¨æœåŠ¡</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é‡æ–°åŠ è½½systemdé…ç½®</span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¯åŠ¨PostgreSQLæœåŠ¡</span>
</span></span><span style=display:flex><span>sudo systemctl start postgresql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¾ç½®å¼€æœºè‡ªå¯</span>
</span></span><span style=display:flex><span>sudo systemctl enable postgresql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æœåŠ¡çŠ¶æ€</span>
</span></span><span style=display:flex><span>sudo systemctl status postgresql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹æ—¥å¿—</span>
</span></span><span style=display:flex><span>sudo journalctl -u postgresql -f
</span></span></code></pre></div><h2 id=-éªŒè¯å’ŒåŸºç¡€é…ç½®>ğŸ”§ éªŒè¯å’ŒåŸºç¡€é…ç½®</h2><h3 id=æ­¥éª¤11éªŒè¯å®‰è£…>æ­¥éª¤11ï¼šéªŒè¯å®‰è£…</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è¿æ¥åˆ°æ•°æ®åº“</span>
</span></span><span style=display:flex><span>psql -h localhost -U postgres -d postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨psqlä¸­æ‰§è¡Œ</span>
</span></span><span style=display:flex><span>SELECT version<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span>SELECT current_user;
</span></span><span style=display:flex><span>SHOW data_directory;
</span></span><span style=display:flex><span>SHOW config_file;
</span></span><span style=display:flex><span><span style=color:#ae81ff>\q</span>  <span style=color:#75715e># é€€å‡º</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤12åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·>æ­¥éª¤12ï¼šåˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ‡æ¢åˆ°postgresç”¨æˆ·</span>
</span></span><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæµ‹è¯•æ•°æ®åº“</span>
</span></span><span style=display:flex><span>createdb test_db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºåº”ç”¨ç”¨æˆ·</span>
</span></span><span style=display:flex><span>createuser -P -d -e app_user
</span></span><span style=display:flex><span><span style=color:#75715e># è¾“å…¥å¯†ç ï¼šAppPass123</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¿æ¥åˆ°æ•°æ®åº“å¹¶æˆæƒ</span>
</span></span><span style=display:flex><span>psql -d test_db <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- åˆ›å»ºschema
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE SCHEMA IF NOT EXISTS app_schema;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- åˆ›å»ºæµ‹è¯•è¡¨
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE TABLE app_schema.users (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    id SERIAL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    username VARCHAR(50) NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    email VARCHAR(100) UNIQUE NOT NULL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- æ’å…¥æµ‹è¯•æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#e6db74>INSERT INTO app_schema.users (username, email) VALUES
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(&#39;admin&#39;, &#39;admin@example.com&#39;),
</span></span></span><span style=display:flex><span><span style=color:#e6db74>(&#39;user1&#39;, &#39;user1@example.com&#39;);
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- æˆæƒç»™åº”ç”¨ç”¨æˆ·
</span></span></span><span style=display:flex><span><span style=color:#e6db74>GRANT ALL PRIVILEGES ON DATABASE test_db TO app_user;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>GRANT ALL PRIVILEGES ON SCHEMA app_schema TO app_user;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA app_schema TO app_user;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA app_schema TO app_user;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>-- æŸ¥çœ‹è¡¨
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT * FROM app_schema.users;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤13å®‰è£…å¸¸ç”¨æ‰©å±•>æ­¥éª¤13ï¼šå®‰è£…å¸¸ç”¨æ‰©å±•</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å®‰è£…pg_stat_statementsï¼ˆæ€§èƒ½ç›‘æ§ï¼‰</span>
</span></span><span style=display:flex><span>psql -U postgres -d test_db <span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE EXTENSION IF NOT EXISTS uuid-ossp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE EXTENSION IF NOT EXISTS btree_gin;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>CREATE EXTENSION IF NOT EXISTS btree_gist;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT * FROM pg_available_extensions ORDER BY name;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h2 id=-é«˜çº§é…ç½®å’Œä¼˜åŒ–>ğŸ› ï¸ é«˜çº§é…ç½®å’Œä¼˜åŒ–</h2><h3 id=å†…å­˜ä¼˜åŒ–é…ç½®>å†…å­˜ä¼˜åŒ–é…ç½®</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æ ¹æ®æœåŠ¡å™¨å†…å­˜è°ƒæ•´é…ç½®</span>
</span></span><span style=display:flex><span>sudo nano /usr/local/pgsql/data/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># å†…å­˜ç›¸å…³ä¼˜åŒ–ï¼ˆ8GBå†…å­˜æœåŠ¡å™¨ç¤ºä¾‹ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>shared_buffers</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>2GB           # å†…å­˜çš„25%</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>work_mem</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>16MB                # æ¯ä¸ªæŸ¥è¯¢çš„å·¥ä½œå†…å­˜</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>maintenance_work_mem</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>512MB   # ç»´æŠ¤æ“ä½œå†…å­˜</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>effective_cache_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>6GB     # å¯ç”¨äºç¼“å­˜çš„ç£ç›˜ç©ºé—´ä¼°è®¡å€¼</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ€§èƒ½ä¼˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_connections</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>200          # æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>checkpoint_completion_target</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>0.9</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>random_page_cost</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1.1         # SSDè®¾ä¸º1.1ï¼ŒHDDè®¾ä¸º4.0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>effective_io_concurrency</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>200 # SSDå¯ä»¥è®¾é«˜ï¼ŒHDDè®¾ä½</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># WALä¼˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_buffers</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>16MB</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>min_wal_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1GB</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_wal_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>4GB</span>
</span></span></code></pre></div><h3 id=é…ç½®å½’æ¡£å’Œå¤‡ä»½>é…ç½®å½’æ¡£å’Œå¤‡ä»½</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºå½’æ¡£ç›®å½•</span>
</span></span><span style=display:flex><span>sudo mkdir -p /usr/local/pgsql/archive
</span></span><span style=display:flex><span>sudo chown postgres:postgres /usr/local/pgsql/archive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é…ç½®å½’æ¡£</span>
</span></span><span style=display:flex><span>sudo nano /usr/local/pgsql/data/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># å¯ç”¨å½’æ¡£</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_mode</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_command</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;test ! -f /usr/local/pgsql/archive/%f &amp;&amp; cp %p /usr/local/pgsql/archive/%f&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>3600  # æ¯å°æ—¶å¼ºåˆ¶å½’æ¡£</span>
</span></span></code></pre></div><h2 id=-ç›‘æ§å’Œç»´æŠ¤è„šæœ¬>ğŸ“Š ç›‘æ§å’Œç»´æŠ¤è„šæœ¬</h2><h3 id=åˆ›å»ºç›‘æ§è„šæœ¬>åˆ›å»ºç›‘æ§è„šæœ¬</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæ•°æ®åº“å¥åº·æ£€æŸ¥è„šæœ¬</span>
</span></span><span style=display:flex><span>sudo tee /usr/local/bin/check_postgres.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74># PostgreSQLå¥åº·æ£€æŸ¥è„šæœ¬
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PGHOME=/usr/local/pgsql
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PGDATA=/usr/local/pgsql/data
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PGPORT=5432
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;=== PostgreSQLå¥åº·æ£€æŸ¥ $(date) ===&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥æœåŠ¡çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#e6db74>systemctl is-active postgresql &gt; /dev/null 2&gt;&amp;1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if [ $? -eq 0 ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ“ æœåŠ¡çŠ¶æ€: è¿è¡Œä¸­&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ— æœåŠ¡çŠ¶æ€: åœæ­¢&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥è¿æ¥
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$PGHOME/bin/pg_isready -p $PGPORT -h localhost -U postgres
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if [ $? -eq 0 ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ“ æ•°æ®åº“è¿æ¥: æ­£å¸¸&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ— æ•°æ®åº“è¿æ¥: å¤±è´¥&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥ç£ç›˜ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#e6db74>df -h $PGDATA | tail -1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥æ•°æ®åº“å¤§å°
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;æ•°æ®åº“å¤§å°:&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>$PGHOME/bin/psql -h localhost -U postgres -d postgres -c &#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    datname as \&#34;æ•°æ®åº“\&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_size_pretty(pg_database_size(datname)) as \&#34;å¤§å°\&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM pg_database 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ORDER BY pg_database_size(datname) DESC;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;=== æ£€æŸ¥å®Œæˆ ===&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/check_postgres.sh
</span></span><span style=display:flex><span>sudo chown postgres:postgres /usr/local/bin/check_postgres.sh
</span></span></code></pre></div><h3 id=åˆ›å»ºå¤‡ä»½è„šæœ¬>åˆ›å»ºå¤‡ä»½è„šæœ¬</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºå¤‡ä»½è„šæœ¬</span>
</span></span><span style=display:flex><span>sudo tee /usr/local/bin/backup_postgres.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74># PostgreSQLå¤‡ä»½è„šæœ¬
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>BACKUP_DIR=&#34;/usr/local/pgsql/backup&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>DATE=$(date +%Y%m%d_%H%M%S)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RETENTION_DAYS=7
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># åˆ›å»ºå¤‡ä»½ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mkdir -p $BACKUP_DIR/$DATE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;å¼€å§‹å¤‡ä»½: $(date)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># å¤‡ä»½æ‰€æœ‰æ•°æ®åº“
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/usr/local/pgsql/bin/pg_dumpall -h localhost -U postgres \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    | gzip &gt; $BACKUP_DIR/$DATE/full_backup_$DATE.sql.gz
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># å¤‡ä»½å•ä¸ªé‡è¦æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/usr/local/pgsql/bin/pg_dump -h localhost -U postgres test_db \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    -F c -f $BACKUP_DIR/$DATE/test_db_$DATE.dump
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;å¤‡ä»½å®Œæˆ: $(date)&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;å¤‡ä»½æ–‡ä»¶:&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ls -lh $BACKUP_DIR/$DATE/
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ¸…ç†æ—§å¤‡ä»½
</span></span></span><span style=display:flex><span><span style=color:#e6db74>find $BACKUP_DIR -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;å·²æ¸…ç†è¶…è¿‡${RETENTION_DAYS}å¤©çš„å¤‡ä»½&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/backup_postgres.sh
</span></span><span style=display:flex><span>sudo chown postgres:postgres /usr/local/bin/backup_postgres.sh
</span></span></code></pre></div><h2 id=-å®‰è£…å…¶ä»–ç¨³å®šç‰ˆæœ¬>ğŸ¯ å®‰è£…å…¶ä»–ç¨³å®šç‰ˆæœ¬</h2><h3 id=å®‰è£…postgresql-157ltsç‰ˆæœ¬>å®‰è£…PostgreSQL 15.7ï¼ˆLTSç‰ˆæœ¬ï¼‰</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/postgresql_src
</span></span><span style=display:flex><span>wget https://ftp.postgresql.org/pub/source/v15.7/postgresql-15.7.tar.gz
</span></span><span style=display:flex><span>tar -zxvf postgresql-15.7.tar.gz
</span></span><span style=display:flex><span>cd postgresql-15.7
</span></span><span style=display:flex><span>mkdir build <span style=color:#f92672>&amp;&amp;</span> cd build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># é…ç½®ï¼ˆä¸16.2ç±»ä¼¼ï¼‰</span>
</span></span><span style=display:flex><span>../configure <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --prefix<span style=color:#f92672>=</span>/usr/local/pgsql15 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-pgport<span style=color:#f92672>=</span><span style=color:#ae81ff>5433</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-openssl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-perl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --with-python
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><h3 id=å®‰è£…postgresql-1412é•¿æœŸæ”¯æŒ>å®‰è£…PostgreSQL 14.12ï¼ˆé•¿æœŸæ”¯æŒï¼‰</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/postgresql_src
</span></span><span style=display:flex><span>wget https://ftp.postgresql.org/pub/source/v14.12/postgresql-14.12.tar.gz
</span></span><span style=display:flex><span>tar -zxvf postgresql-14.12.tar.gz
</span></span><span style=display:flex><span>cd postgresql-14.12
</span></span><span style=display:flex><span>mkdir build <span style=color:#f92672>&amp;&amp;</span> cd build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>../configure --prefix<span style=color:#f92672>=</span>/usr/local/pgsql14 --with-openssl
</span></span><span style=display:flex><span>make -j<span style=color:#66d9ef>$(</span>nproc<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><h2 id=-æ•…éšœæ’é™¤>âš ï¸ æ•…éšœæ’é™¤</h2><h3 id=å¸¸è§é—®é¢˜è§£å†³>å¸¸è§é—®é¢˜è§£å†³</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. ç¼–è¯‘é”™è¯¯ï¼šç¼ºå°‘ä¾èµ–</span>
</span></span><span style=display:flex><span><span style=color:#75715e># é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–åæ¸…ç†é‡è¯•</span>
</span></span><span style=display:flex><span>make distclean
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. å¯åŠ¨å¤±è´¥ï¼šç«¯å£è¢«å ç”¨</span>
</span></span><span style=display:flex><span>netstat -tlnp | grep <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>sudo lsof -i :5432
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. è¿æ¥å¤±è´¥ï¼šè®¤è¯é—®é¢˜</span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ£€æŸ¥pg_hba.confé…ç½®</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. å†…å­˜ä¸è¶³ï¼šè°ƒæ•´ç¼–è¯‘å¹¶è¡Œåº¦</span>
</span></span><span style=display:flex><span>make -j2  <span style=color:#75715e># ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œä»»åŠ¡</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 5. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—</span>
</span></span><span style=display:flex><span>tail -f /usr/local/pgsql/data/log/postgresql-*.log
</span></span></code></pre></div><h2 id=-æ€»ç»“>ğŸ“ æ€»ç»“</h2><h3 id=å®‰è£…æ­¥éª¤å›é¡¾>å®‰è£…æ­¥éª¤å›é¡¾</h3><ol><li><strong>å®‰è£…ä¾èµ–</strong>ï¼šç¡®ä¿ç¼–è¯‘ç¯å¢ƒå®Œæ•´</li><li><strong>ä¸‹è½½æºç </strong>ï¼šé€‰æ‹©ç¨³å®šç‰ˆæœ¬ï¼ˆæ¨è16.2æˆ–15.7ï¼‰</li><li><strong>é…ç½®ç¼–è¯‘</strong>ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©ç¼–è¯‘é€‰é¡¹</li><li><strong>ç¼–è¯‘å®‰è£…</strong>ï¼šä½¿ç”¨å¹¶è¡Œç¼–è¯‘æé«˜é€Ÿåº¦</li><li><strong>åˆå§‹åŒ–æ•°æ®åº“</strong>ï¼šè®¾ç½®æ•°æ®ç›®å½•å’Œç¼–ç </li><li><strong>é…ç½®å‚æ•°</strong>ï¼šä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨</li><li><strong>åˆ›å»ºæœåŠ¡</strong>ï¼šä½¿ç”¨systemdç®¡ç†</li><li><strong>éªŒè¯æµ‹è¯•</strong>ï¼šç¡®ä¿å®‰è£…æˆåŠŸ</li></ol><h3 id=ç‰ˆæœ¬é€‰æ‹©å»ºè®®>ç‰ˆæœ¬é€‰æ‹©å»ºè®®</h3><ul><li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼šPostgreSQL 15.xï¼ˆLTSæ”¯æŒåˆ°2027å¹´ï¼‰</li><li><strong>å­¦ä¹ æµ‹è¯•</strong>ï¼šPostgreSQL 16.xï¼ˆæœ€æ–°ç‰¹æ€§ï¼‰</li><li><strong>å…¼å®¹æ€§è¦æ±‚</strong>ï¼šPostgreSQL 14.xï¼ˆæ”¯æŒåˆ°2026å¹´ï¼‰</li></ul><h3 id=å…³é”®é…ç½®æ–‡ä»¶>å…³é”®é…ç½®æ–‡ä»¶</h3><ul><li><code>/usr/local/pgsql/data/postgresql.conf</code> - ä¸»é…ç½®æ–‡ä»¶</li><li><code>/usr/local/pgsql/data/pg_hba.conf</code> - å®¢æˆ·ç«¯è®¤è¯</li><li><code>/etc/systemd/system/postgresql.service</code> - æœåŠ¡æ–‡ä»¶</li></ul><p>é€šè¿‡æºç å®‰è£…å¯ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œå®šåˆ¶æ€§ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒå’Œå¯¹æ€§èƒ½æœ‰è¦æ±‚çš„åœºæ™¯ã€‚</p><h1 id=é…ç½®-postgresql-ä¸»ä»å¤åˆ¶è¿œç¨‹--æœ¬åœ°-macos-å¤‡ä»½>é…ç½® PostgreSQL ä¸»ä»å¤åˆ¶ï¼ˆè¿œç¨‹ â†’ æœ¬åœ° macOS å¤‡ä»½ï¼‰</h1><p>æˆ‘å°†å¸®ä½ é…ç½® <code>qiaopan.tech</code>ï¼ˆè¿œç¨‹æœåŠ¡å™¨ï¼‰ä½œä¸ºä¸»åº“ï¼Œæœ¬åœ° macOS ä½œä¸ºä»åº“è¿›è¡Œå¼‚æ­¥å¤åˆ¶ï¼Œç”¨äºæ•°æ®å¤‡ä»½ã€‚</p><h2 id=-æ¶æ„è®¾è®¡>ğŸ“‹ <strong>æ¶æ„è®¾è®¡</strong></h2><pre tabindex=0><code>ä¸»åº“ (è¿œç¨‹æœåŠ¡å™¨)         ä»åº“ (æœ¬åœ° macOS)
qiaopan.tech:5432  â†’   æœ¬åœ°:5432
     â†“
å®šæ—¶åŒæ­¥å¤‡ä»½
</code></pre><h2 id=-ç¬¬ä¸€éƒ¨åˆ†é…ç½®è¿œç¨‹ä¸»åº“qiaopantech>ğŸ”§ <strong>ç¬¬ä¸€éƒ¨åˆ†ï¼šé…ç½®è¿œç¨‹ä¸»åº“ï¼ˆqiaopan.techï¼‰</strong></h2><h3 id=æ­¥éª¤1åˆ›å»ºå¤åˆ¶ç”¨æˆ·><strong>æ­¥éª¤1ï¼šåˆ›å»ºå¤åˆ¶ç”¨æˆ·</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-- åˆ›å»ºå¤åˆ¶ä¸“ç”¨ç”¨æˆ·
</span></span><span style=display:flex><span>CREATE USER replicator WITH REPLICATION LOGIN 
</span></span><span style=display:flex><span>    PASSWORD <span style=color:#e6db74>&#39;YourStrongReplicaPass123!&#39;</span>
</span></span><span style=display:flex><span>    CONNECTION LIMIT <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>    VALID UNTIL <span style=color:#e6db74>&#39;2025-12-31&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>-- éªŒè¯åˆ›å»º
</span></span><span style=display:flex><span><span style=color:#ae81ff>\d</span>u replicator
</span></span></code></pre></div><h3 id=æ­¥éª¤2é…ç½®ä¸»åº“-postgresqlconf><strong>æ­¥éª¤2ï¼šé…ç½®ä¸»åº“ postgresql.conf</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># è¿œç¨‹æœåŠ¡å™¨ä¸Šç¼–è¾‘é…ç½®æ–‡ä»¶</span>
</span></span><span style=display:flex><span>sudo nano /etc/postgresql/16/main/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># ä¿®æ”¹æˆ–æ·»åŠ ä»¥ä¸‹é…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>listen_addresses</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;*&#39;                     # å…è®¸æ‰€æœ‰IPè¿æ¥ï¼ˆæˆ–æŒ‡å®šå…·ä½“IPï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>5432                               # é»˜è®¤ç«¯å£</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_level</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>replica                       # å¤åˆ¶çº§åˆ«</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_wal_senders</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10                      # æœ€å¤§WALå‘é€è¿›ç¨‹æ•°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_keep_size</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>1024                      # ä¿ç•™1GBçš„WALæ—¥å¿—</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_replication_slots</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10                # æœ€å¤§å¤åˆ¶æ§½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>hot_standby</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on                          # ä»åº“å¯è¯»</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_mode</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on                         # å¼€å¯å½’æ¡£</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>archive_command</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;test ! -f /var/lib/postgresql/16/main/archive/%f &amp;&amp; cp %p /var/lib/postgresql/16/main/archive/%f&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æ€§èƒ½ä¼˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>synchronous_commit</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>off                  # å¼‚æ­¥å¤åˆ¶ï¼Œæ€§èƒ½æ›´å¥½</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_sender_timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>60s                  # å‘é€è¶…æ—¶æ—¶é—´</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤3é…ç½®å®¢æˆ·ç«¯è®¤è¯pg_><strong>æ­¥éª¤3ï¼šé…ç½®å®¢æˆ·ç«¯è®¤è¯ï¼ˆpg_hba.confï¼‰</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/postgresql/16/main/pg_hba.conf
</span></span></code></pre></div><pre tabindex=0><code class=language-conf data-lang=conf># æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ ¹æ®ä½ çš„æœ¬åœ°IPé…ç½®ï¼‰
# å…è®¸æœ¬åœ°macOSè¿æ¥è¿›è¡Œå¤åˆ¶
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    replication     replicator      your_local_ip/32        md5
# å¦‚æœæœ¬åœ°IPç»å¸¸å˜åŒ–ï¼Œå¯ä»¥æ”¾å®½é™åˆ¶ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰
# host    replication     replicator      0.0.0.0/0               md5

# è·å–ä½ çš„å…¬ç½‘IPï¼ˆåœ¨æœ¬åœ°macOSæ‰§è¡Œï¼‰
curl ifconfig.me
</code></pre><h3 id=æ­¥éª¤4é‡å¯è¿œç¨‹postgresqlå¹¶åˆ›å»ºå¤åˆ¶æ§½><strong>æ­¥éª¤4ï¼šé‡å¯è¿œç¨‹PostgreSQLå¹¶åˆ›å»ºå¤åˆ¶æ§½</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># é‡å¯æœåŠ¡</span>
</span></span><span style=display:flex><span>sudo systemctl restart postgresql@16-main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºå¤åˆ¶æ§½ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;SELECT * FROM pg_create_physical_replication_slot(&#39;macos_backup_slot&#39;);&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å¤åˆ¶æ§½</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;SELECT * FROM pg_replication_slots;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å½“å‰WALä½ç½®</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;SELECT pg_current_wal_lsn();&#34;</span>
</span></span></code></pre></div><h2 id=-ç¬¬äºŒéƒ¨åˆ†é…ç½®æœ¬åœ°macosä»åº“>ğŸ”§ <strong>ç¬¬äºŒéƒ¨åˆ†ï¼šé…ç½®æœ¬åœ°macOSä»åº“</strong></h2><h3 id=æ­¥éª¤1å‡†å¤‡æœ¬åœ°ç¯å¢ƒ><strong>æ­¥éª¤1ï¼šå‡†å¤‡æœ¬åœ°ç¯å¢ƒ</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åœæ­¢æœ¬åœ°PostgreSQLï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/pg_ctl -D /Library/PostgreSQL/16/data stop
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆå¦‚æœé‡è¦ï¼‰</span>
</span></span><span style=display:flex><span>sudo cp -r /Library/PostgreSQL/16/data /Library/PostgreSQL/16/data.backup.<span style=color:#66d9ef>$(</span>date +%Y%m%d<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ é™¤ç°æœ‰æ•°æ®ç›®å½•</span>
</span></span><span style=display:flex><span>sudo rm -rf /Library/PostgreSQL/16/data
</span></span></code></pre></div><h3 id=æ­¥éª¤2ä»ä¸»åº“åŒæ­¥åŸºç¡€æ•°æ®><strong>æ­¥éª¤2ï¼šä»ä¸»åº“åŒæ­¥åŸºç¡€æ•°æ®</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ä½¿ç”¨pg_basebackupä»è¿œç¨‹ä¸»åº“åŒæ­¥æ•°æ®</span>
</span></span><span style=display:flex><span>sudo -u postgres /Library/PostgreSQL/16/bin/pg_basebackup <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -h qiaopan.tech <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -p <span style=color:#ae81ff>5432</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -U replicator <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -D /Library/PostgreSQL/16/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -Fp <span style=color:#ae81ff>\ </span>             <span style=color:#75715e># æ™®é€šæ ¼å¼</span>
</span></span><span style=display:flex><span>    -Xs <span style=color:#ae81ff>\ </span>             <span style=color:#75715e># ä½¿ç”¨æµå¼å¤åˆ¶</span>
</span></span><span style=display:flex><span>    -R <span style=color:#ae81ff>\ </span>              <span style=color:#75715e># ç”Ÿæˆrecoveryé…ç½®</span>
</span></span><span style=display:flex><span>    -P <span style=color:#ae81ff>\ </span>              <span style=color:#75715e># æ˜¾ç¤ºè¿›åº¦</span>
</span></span><span style=display:flex><span>    -v                 <span style=color:#75715e># è¯¦ç»†è¾“å‡º</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è¾“å…¥å¯†ç ï¼šYourStrongReplicaPass123!</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤3é…ç½®ä»åº“æ¢å¤å‚æ•°><strong>æ­¥éª¤3ï¼šé…ç½®ä»åº“æ¢å¤å‚æ•°</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹ç”Ÿæˆçš„é…ç½®</span>
</span></span><span style=display:flex><span>cat /Library/PostgreSQL/16/data/standby.signal
</span></span><span style=display:flex><span>cat /Library/PostgreSQL/16/data/postgresql.auto.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¦‚æœæœªè‡ªåŠ¨ç”Ÿæˆï¼Œæ‰‹åŠ¨åˆ›å»º</span>
</span></span><span style=display:flex><span>sudo tee /Library/PostgreSQL/16/data/standby.signal <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>standby_mode = &#39;on&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºæ¢å¤é…ç½®</span>
</span></span><span style=display:flex><span>sudo tee /Library/PostgreSQL/16/data/postgresql.auto.conf <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>primary_conninfo = &#39;host=qiaopan.tech port=5432 user=replicator password=YourStrongReplicaPass123! application_name=macos_backup&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>primary_slot_name = &#39;macos_backup_slot&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>restore_command = &#39;cp /var/lib/postgresql/archive/%f %p&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>recovery_target_timeline = &#39;latest&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>hot_standby = &#39;on&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¾ç½®æƒé™</span>
</span></span><span style=display:flex><span>sudo chown -R postgres:staff /Library/PostgreSQL/16/data
</span></span></code></pre></div><h3 id=æ­¥éª¤4é…ç½®æœ¬åœ°postgresqlconf><strong>æ­¥éª¤4ï¼šé…ç½®æœ¬åœ°postgresql.conf</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /Library/PostgreSQL/16/data/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># ä»åº“ç‰¹æœ‰é…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>hot_standby</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>hot_standby_feedback</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_standby_streaming_delay</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>30s</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_standby_archive_delay</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>30s</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_receiver_status_interval</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>10s</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¾ç½®ä¸ºåªè¯»æ¨¡å¼ï¼ˆå¤‡ä»½ç”¨é€”ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>default_transaction_read_only</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>on</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç›‘å¬é…ç½®ï¼ˆæœ¬åœ°ä½¿ç”¨ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>listen_addresses</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>5432</span>
</span></span></code></pre></div><h3 id=æ­¥éª¤5å¯åŠ¨æœ¬åœ°ä»åº“><strong>æ­¥éª¤5ï¼šå¯åŠ¨æœ¬åœ°ä»åº“</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å¯åŠ¨PostgreSQL</span>
</span></span><span style=display:flex><span>sudo -u postgres /Library/PostgreSQL/16/bin/pg_ctl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -D /Library/PostgreSQL/16/data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    -l /Library/PostgreSQL/16/logfile <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å¯åŠ¨æ—¥å¿—</span>
</span></span><span style=display:flex><span>tail -f /Library/PostgreSQL/16/logfile
</span></span></code></pre></div><h2 id=-éªŒè¯å¤åˆ¶çŠ¶æ€>ğŸ” <strong>éªŒè¯å¤åˆ¶çŠ¶æ€</strong></h2><h3 id=åœ¨è¿œç¨‹ä¸»åº“ä¸Šæ£€æŸ¥><strong>åœ¨è¿œç¨‹ä¸»åº“ä¸Šæ£€æŸ¥</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å¤åˆ¶è¿æ¥çŠ¶æ€</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pid,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    usename,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    application_name,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    client_addr,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    state,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    sync_state,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_wal_lsn_diff(pg_current_wal_lsn(), sent_lsn) as sent_lag_bytes,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_wal_lsn_diff(pg_current_wal_lsn(), write_lsn) as write_lag_bytes,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_wal_lsn_diff(pg_current_wal_lsn(), flush_lsn) as flush_lag_bytes,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as replay_lag_bytes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM pg_stat_replication;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å¤åˆ¶æ§½çŠ¶æ€</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;SELECT * FROM pg_replication_slots;&#34;</span>
</span></span></code></pre></div><h3 id=åœ¨æœ¬åœ°ä»åº“ä¸Šæ£€æŸ¥><strong>åœ¨æœ¬åœ°ä»åº“ä¸Šæ£€æŸ¥</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æ£€æŸ¥æ¢å¤çŠ¶æ€</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/psql -U postgres -c <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_is_in_recovery() as is_in_recovery,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_last_wal_receive_lsn() as last_receive_lsn,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_last_wal_replay_lsn() as last_replay_lsn,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_last_xact_replay_timestamp() as last_replay_time,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    now() - pg_last_xact_replay_timestamp() as replay_delay,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) as replay_lag_bytes;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># æµ‹è¯•æ•°æ®åŒæ­¥</span>
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨ä¸»åº“åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sshåˆ°è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œï¼š</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo -i -u postgres psql -c &#34;CREATE DATABASE backup_test;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo -i -u postgres psql -d backup_test -c &#34;CREATE TABLE test_data AS SELECT generate_series(1,1000) as id, md5(random()::text) as data;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åœ¨æœ¬åœ°éªŒè¯æ•°æ®</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/psql -U postgres -d backup_test -c <span style=color:#e6db74>&#34;SELECT COUNT(*) FROM test_data;&#34;</span>
</span></span></code></pre></div><h2 id=-åˆ›å»ºç›‘æ§å’Œç®¡ç†è„šæœ¬>ğŸ“Š <strong>åˆ›å»ºç›‘æ§å’Œç®¡ç†è„šæœ¬</strong></h2><h3 id=ç›‘æ§è„šæœ¬check_><strong>ç›‘æ§è„šæœ¬ï¼šcheck_replication_status.sh</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /usr/local/bin/check_replication_status.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥ä¸»ä»å¤åˆ¶çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PRIMARY_HOST=&#34;qiaopan.tech&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PRIMARY_PORT=&#34;5432&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>PRIMARY_USER=&#34;postgres&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>REPLICA_DATA=&#34;/Library/PostgreSQL/16/data&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;=== PostgreSQL å¤åˆ¶çŠ¶æ€æ£€æŸ¥ $(date) ===&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;ä¸»åº“: ${PRIMARY_HOST}:${PRIMARY_PORT}&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;ä»åº“: localhost:5432&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥ä»åº“çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo -e &#34;\n1. ä»åº“çŠ¶æ€:&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if /Library/PostgreSQL/16/bin/pg_isready -h localhost; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ“ ä»åº“æœåŠ¡æ­£å¸¸&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # æ£€æŸ¥æ˜¯å¦åœ¨æ¢å¤æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    RECOVERY_STATUS=$(/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;SELECT pg_is_in_recovery();&#34; 2&gt;/dev/null)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if [ &#34;$RECOVERY_STATUS&#34; = &#34;t&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;âœ“ è¿è¡Œåœ¨æ¢å¤æ¨¡å¼ï¼ˆä»åº“ï¼‰&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿ
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo -e &#34;\n2. å¤åˆ¶å»¶è¿Ÿ:&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        /Library/PostgreSQL/16/bin/psql -U postgres -c &#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            now() - pg_last_xact_replay_timestamp() AS replication_delay,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            pg_size_pretty(pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn())) AS replay_lag,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            pg_last_xact_replay_timestamp() AS last_replay_time;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;âœ— ä¸åœ¨æ¢å¤æ¨¡å¼ï¼Œå¯èƒ½ä¸æ˜¯ä»åº“&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ— ä»åº“æœåŠ¡å¼‚å¸¸&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># æ£€æŸ¥ä¸»åº“è¿æ¥ï¼ˆå¯é€‰ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo -e &#34;\n3. ä¸»åº“è¿æ¥æµ‹è¯•:&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if nc -z $PRIMARY_HOST $PRIMARY_PORT 2&gt;/dev/null; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ“ å¯ä»¥è¿æ¥åˆ°ä¸»åº“ç«¯å£&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;âœ— æ— æ³•è¿æ¥åˆ°ä¸»åº“ç«¯å£&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo -e &#34;\n=== æ£€æŸ¥å®Œæˆ ===&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/check_replication_status.sh
</span></span></code></pre></div><h3 id=å®šæ—¶å¤‡ä»½éªŒè¯è„šæœ¬><strong>å®šæ—¶å¤‡ä»½éªŒè¯è„šæœ¬</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /usr/local/bin/verify_backup.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74># éªŒè¯å¤‡ä»½æ•°æ®çš„å®Œæ•´æ€§
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LOG_FILE=&#34;/Library/PostgreSQL/16/logs/backup_verify.log&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>REPLICA_DATA=&#34;/Library/PostgreSQL/16/data&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># åˆ›å»ºæ—¥å¿—ç›®å½•
</span></span></span><span style=display:flex><span><span style=color:#e6db74>mkdir -p /Library/PostgreSQL/16/logs
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;$(date): å¼€å§‹å¤‡ä»½éªŒè¯&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 1. æ£€æŸ¥ä»åº“çŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if ! /Library/PostgreSQL/16/bin/pg_isready -h localhost; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;$(date): é”™è¯¯: ä»åº“æœåŠ¡æœªè¿è¡Œ&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    exit 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 2. æ£€æŸ¥æ¢å¤æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#e6db74>RECOVERY_STATUS=$(/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;SELECT pg_is_in_recovery();&#34; 2&gt;/dev/null)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if [ &#34;$RECOVERY_STATUS&#34; != &#34;t&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    echo &#34;$(date): è­¦å‘Š: ä¸åœ¨æ¢å¤æ¨¡å¼&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 3. æ£€æŸ¥æœ€è¿‘çš„å¤åˆ¶æ´»åŠ¨
</span></span></span><span style=display:flex><span><span style=color:#e6db74>LAST_REPLAY=$(/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;SELECT pg_last_xact_replay_timestamp();&#34; 2&gt;/dev/null)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if [ -n &#34;$LAST_REPLAY&#34; ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    REPLAY_AGE=$(/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;SELECT EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()));&#34; 2&gt;/dev/null)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if [ $(echo &#34;$REPLAY_AGE &gt; 300&#34; | bc) -eq 1 ]; then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;$(date): è­¦å‘Š: æœ€è¿‘5åˆ†é’Ÿå†…æ²¡æœ‰å¤åˆ¶æ´»åŠ¨&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        echo &#34;$(date): æ­£å¸¸: æœ€è¿‘æœ‰å¤åˆ¶æ´»åŠ¨ ($REPLAY_AGE ç§’å‰)&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>fi
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 4. æ£€æŸ¥å…³é”®æ•°æ®åº“çš„å®Œæ•´æ€§
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;$(date): æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    datname,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_size_pretty(pg_database_size(datname)) as size,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_stat_file(&#39;base/&#39; || oid || &#39;/PG_VERSION&#39;) IS NOT NULL as files_ok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM pg_database 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WHERE datname NOT IN (&#39;template0&#39;, &#39;template1&#39;, &#39;postgres&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>ORDER BY pg_database_size(datname) DESC;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># 5. æ£€æŸ¥è¡¨ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo -e &#34;\n$(date): è¡¨ç©ºé—´çŠ¶æ€:&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/Library/PostgreSQL/16/bin/psql -U postgres -t -c &#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    spcname,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_tablespace_location(oid) as location,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_stat_file(pg_tablespace_location(oid)) IS NOT NULL as accessible
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM pg_tablespace;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo &#34;$(date): å¤‡ä»½éªŒè¯å®Œæˆ&#34; | tee -a $LOG_FILE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /usr/local/bin/verify_backup.sh
</span></span></code></pre></div><h2 id=-é…ç½®å®šæ—¶ä»»åŠ¡crontab>ğŸ”„ <strong>é…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆcrontabï¼‰</strong></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># ç¼–è¾‘å½“å‰ç”¨æˆ·çš„crontab</span>
</span></span><span style=display:flex><span>crontab -e
</span></span></code></pre></div><p>æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p><pre tabindex=0><code class=language-crontab data-lang=crontab># PostgreSQL å¤‡ä»½ç›‘æ§å’ŒéªŒè¯
# æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¤åˆ¶çŠ¶æ€
*/30 * * * * /usr/local/bin/check_replication_status.sh &gt;&gt; /Library/PostgreSQL/16/logs/replication_monitor.log 2&gt;&amp;1

# æ¯å¤©å‡Œæ™¨2ç‚¹éªŒè¯å¤‡ä»½å®Œæ•´æ€§
0 2 * * * /usr/local/bin/verify_backup.sh

# æ¯å‘¨ä¸€å‡Œæ™¨3ç‚¹æ¸…ç†æ—§æ—¥å¿—
0 3 * * 1 find /Library/PostgreSQL/16/logs -name &#34;*.log&#34; -mtime +30 -delete

# æ¯å°æ—¶å‘é€ä¸€æ¬¡å¥åº·æŠ¥å‘Šåˆ°é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
# 0 * * * * /usr/local/bin/send_health_report.sh
</code></pre><h2 id=-æ•…éšœæ’é™¤å’Œæ¢å¤>ğŸ› ï¸ <strong>æ•…éšœæ’é™¤å’Œæ¢å¤</strong></h2><h3 id=é—®é¢˜1ç½‘ç»œä¸­æ–­åçš„æ¢å¤><strong>é—®é¢˜1ï¼šç½‘ç»œä¸­æ–­åçš„æ¢å¤</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å¦‚æœç½‘ç»œä¸­æ–­å¯¼è‡´å¤åˆ¶åœæ­¢</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 1. æ£€æŸ¥ä¸»åº“æ˜¯å¦å¯è®¿é—®</span>
</span></span><span style=display:flex><span>ping -c <span style=color:#ae81ff>3</span> qiaopan.tech
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. åœ¨ä»åº“é‡æ–°å¯åŠ¨å¤åˆ¶</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/pg_ctl -D /Library/PostgreSQL/16/data restart
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°åŒæ­¥</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/pg_ctl -D /Library/PostgreSQL/16/data stop
</span></span><span style=display:flex><span>sudo rm -rf /Library/PostgreSQL/16/data
</span></span><span style=display:flex><span>sudo -u postgres /Library/PostgreSQL/16/bin/pg_basebackup -h qiaopan.tech -p <span style=color:#ae81ff>5432</span> -U replicator -D /Library/PostgreSQL/16/data -Fp -Xs -R -P
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/pg_ctl -D /Library/PostgreSQL/16/data start
</span></span></code></pre></div><h3 id=é—®é¢˜2å¤åˆ¶å»¶è¿Ÿè¿‡å¤§><strong>é—®é¢˜2ï¼šå¤åˆ¶å»¶è¿Ÿè¿‡å¤§</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># æŸ¥çœ‹å½“å‰å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/psql -U postgres -c <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    now() - pg_last_xact_replay_timestamp() as replication_delay,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_size_pretty(pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn())) as replay_lag;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¦‚æœå»¶è¿Ÿè¿‡å¤§ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæˆ–æ€§èƒ½é—®é¢˜</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ä¼˜åŒ–æœ¬åœ°macOS PostgreSQLé…ç½®</span>
</span></span><span style=display:flex><span>sudo nano /Library/PostgreSQL/16/data/postgresql.conf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#75715e># å¢åŠ ä»¥ä¸‹ä¼˜åŒ–å‚æ•°</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_standby_streaming_delay</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>-1        # ç¦ç”¨å»¶è¿Ÿï¼Œå°½å¿«åº”ç”¨</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>max_standby_archive_delay</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>-1          # ç¦ç”¨å½’æ¡£å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wal_receiver_timeout</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>120s             # å¢åŠ æ¥æ”¶è¶…æ—¶</span>
</span></span></code></pre></div><h3 id=é—®é¢˜3ä¸»åº“ç©ºé—´ä¸è¶³><strong>é—®é¢˜3ï¼šä¸»åº“ç©ºé—´ä¸è¶³</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åœ¨ä¸»åº“æ£€æŸ¥WALæ—¥å¿—å¤§å°</span>
</span></span><span style=display:flex><span>sudo -i -u postgres psql -c <span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    slot_name,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as replication_lag,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    active
</span></span></span><span style=display:flex><span><span style=color:#e6db74>FROM pg_replication_slots;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># å¦‚æœä»åº“é•¿æ—¶é—´ç¦»çº¿ï¼Œå¯èƒ½éœ€è¦æ¸…ç†å¤åˆ¶æ§½</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo -i -u postgres psql -c &#34;SELECT pg_drop_replication_slot(&#39;macos_backup_slot&#39;);&#34;</span>
</span></span></code></pre></div><h2 id=-åˆ›å»ºç®€å•çš„webç›‘æ§ç•Œé¢å¯é€‰>ğŸ“± <strong>åˆ›å»ºç®€å•çš„Webç›‘æ§ç•Œé¢ï¼ˆå¯é€‰ï¼‰</strong></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># å®‰è£…Pythonä¾èµ–</span>
</span></span><span style=display:flex><span>pip3 install flask psycopg2-binary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºç›‘æ§åº”ç”¨</span>
</span></span><span style=display:flex><span>sudo tee /Library/PostgreSQL/16/scripts/monitor_app.py <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/usr/bin/env python3
</span></span></span><span style=display:flex><span><span style=color:#e6db74>from flask import Flask, jsonify
</span></span></span><span style=display:flex><span><span style=color:#e6db74>import psycopg2
</span></span></span><span style=display:flex><span><span style=color:#e6db74>import psycopg2.extras
</span></span></span><span style=display:flex><span><span style=color:#e6db74>import os
</span></span></span><span style=display:flex><span><span style=color:#e6db74>from datetime import datetime
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>app = Flask(__name__)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>def get_replication_status():
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;è·å–å¤åˆ¶çŠ¶æ€&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    try:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        conn = psycopg2.connect(
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            host=&#34;localhost&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            port=5432,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            user=&#34;postgres&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            database=&#34;postgres&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # æ£€æŸ¥æ˜¯å¦åœ¨æ¢å¤æ¨¡å¼
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        cursor.execute(&#34;SELECT pg_is_in_recovery() as is_replica&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        is_replica = cursor.fetchone()[&#39;is_replica&#39;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if is_replica:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # è·å–å¤åˆ¶å»¶è¿Ÿä¿¡æ¯
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            cursor.execute(&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    now() - pg_last_xact_replay_timestamp() as replication_delay,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    pg_wal_lsn_diff(pg_last_wal_receive_lsn(), pg_last_wal_replay_lsn()) as replay_lag_bytes,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    pg_last_xact_replay_timestamp() as last_replay_time,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    pg_last_wal_receive_lsn() as last_receive_lsn,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    pg_last_wal_replay_lsn() as last_replay_lsn
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            replication_info = dict(cursor.fetchone())
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # è®¡ç®—å»¶è¿Ÿç§’æ•°
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            if replication_info[&#39;replication_delay&#39;]:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                replication_info[&#39;replication_delay_seconds&#39;] = replication_info[&#39;replication_delay&#39;].total_seconds()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            else:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                replication_info[&#39;replication_delay_seconds&#39;] = None
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            replication_info[&#39;status&#39;] = &#39;replicating&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        else:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            replication_info = {&#39;status&#39;: &#39;not_replica&#39;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        conn.close()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        return replication_info
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    except Exception as e:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        return {&#39;status&#39;: &#39;error&#39;, &#39;message&#39;: str(e)}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>@app.route(&#39;/api/replication/status&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>def replication_status():
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;è¿”å›å¤åˆ¶çŠ¶æ€API&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return jsonify(get_replication_status())
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>@app.route(&#39;/api/databases&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>def list_databases():
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    try:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        conn = psycopg2.connect(
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            host=&#34;localhost&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            port=5432,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            user=&#34;postgres&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            database=&#34;postgres&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        )
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        cursor = conn.cursor(cursor_factory=psycopg2.extras.DictCursor)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        cursor.execute(&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            SELECT 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                datname,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                pg_size_pretty(pg_database_size(datname)) as size,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                datcollate,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                pg_stat_file(&#39;base/&#39; || oid || &#39;/PG_VERSION&#39;) IS NOT NULL as files_ok
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            FROM pg_database 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            WHERE datname NOT IN (&#39;template0&#39;, &#39;template1&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ORDER BY pg_database_size(datname) DESC
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        databases = []
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        for row in cursor:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            databases.append(dict(row))
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        conn.close()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        return jsonify({&#39;databases&#39;: databases})
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    except Exception as e:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        return jsonify({&#39;error&#39;: str(e)})
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>@app.route(&#39;/&#39;)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>def index():
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;ç®€å•ç›‘æ§é¡µé¢&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    status = get_replication_status()
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    html = f&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;title&gt;PostgreSQL å¤‡ä»½ç›‘æ§&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;style&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            body {{ font-family: Arial, sans-serif; margin: 40px; }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            .status {{ padding: 20px; border-radius: 5px; }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            .healthy {{ background-color: #d4edda; color: #155724; }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            .warning {{ background-color: #fff3cd; color: #856404; }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            .error {{ background-color: #f8d7da; color: #721c24; }}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/style&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;h1&gt;PostgreSQL å¤‡ä»½ç›‘æ§&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;p&gt;æ—¶é—´: {datetime.now().strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)}&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;div class=&#34;status {&#39;healthy&#39; if status.get(&#39;status&#39;) == &#39;replicating&#39; else &#39;error&#39;}&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;h2&gt;å¤åˆ¶çŠ¶æ€: {status.get(&#39;status&#39;, &#39;unknown&#39;)}&lt;/h2&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    if status.get(&#39;status&#39;) == &#39;replicating&#39;:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        html += f&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;p&gt;å¤åˆ¶å»¶è¿Ÿ: {status.get(&#39;replication_delay_seconds&#39;, &#39;N/A&#39;)} ç§’&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;p&gt;æœ€åå¤åˆ¶æ—¶é—´: {status.get(&#39;last_replay_time&#39;)}&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;p&gt;WAL æ¥æ”¶ä½ç½®: {status.get(&#39;last_receive_lsn&#39;)}&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &lt;p&gt;WAL é‡æ”¾ä½ç½®: {status.get(&#39;last_replay_lsn&#39;)}&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    elif status.get(&#39;status&#39;) == &#39;error&#39;:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        html += f&#34;&lt;p&gt;é”™è¯¯: {status.get(&#39;message&#39;)}&lt;/p&gt;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    html += &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;/div&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;p&gt;&lt;a href=&#34;/api/replication/status&#34;&gt;JSON çŠ¶æ€&lt;/a&gt; | 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &lt;a href=&#34;/api/databases&#34;&gt;æ•°æ®åº“åˆ—è¡¨&lt;/a&gt;&lt;/p&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &lt;/html&gt;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    return html
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>if __name__ == &#39;__main__&#39;:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    app.run(host=&#39;127.0.0.1&#39;, port=5000, debug=False)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># åˆ›å»ºå¯åŠ¨è„šæœ¬</span>
</span></span><span style=display:flex><span>sudo tee /Library/PostgreSQL/16/scripts/start_monitor.sh <span style=color:#e6db74>&lt;&lt; &#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#e6db74>cd /Library/PostgreSQL/16/scripts
</span></span></span><span style=display:flex><span><span style=color:#e6db74>nohup python3 monitor_app.py &gt; monitor.log 2&gt;&amp;1 &amp;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo $! &gt; monitor.pid
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chmod +x /Library/PostgreSQL/16/scripts/start_monitor.sh
</span></span></code></pre></div><h2 id=-å®‰å…¨å»ºè®®>ğŸ“ <strong>å®‰å…¨å»ºè®®</strong></h2><ol><li><p><strong>ä½¿ç”¨SSHéš§é“ï¼ˆæ¨èï¼‰</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åœ¨æœ¬åœ°macOSåˆ›å»ºSSHéš§é“</span>
</span></span><span style=display:flex><span>ssh -N -L 5433:localhost:5432 user@qiaopan.tech
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ç„¶ååœ¨é…ç½®ä¸­ä½¿ç”¨ localhost:5433 è¿æ¥</span>
</span></span></code></pre></div></li><li><p><strong>åŠ å¼ºå¯†ç å®‰å…¨</strong>ï¼š</p><ul><li>ä½¿ç”¨å¼ºå¯†ç </li><li>å®šæœŸæ›´æ¢å¤åˆ¶ç”¨æˆ·å¯†ç </li><li>ä½¿ç”¨ä¸åŒå¯†ç ç”¨äºä¸åŒç”¨é€”</li></ul></li><li><p><strong>é™åˆ¶è®¿é—®IP</strong>ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># åœ¨ä¸»åº“pg_hba.confä¸­åªå…è®¸ä½ çš„å…¬ç½‘IP</span>
</span></span><span style=display:flex><span>host    replication     replicator      your_public_ip/32        md5
</span></span></code></pre></div></li></ol><h2 id=-å®ŒæˆéªŒè¯>âœ… <strong>å®ŒæˆéªŒè¯</strong></h2><p>æµ‹è¯•ä¸€åˆ‡æ­£å¸¸å·¥ä½œï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># 1. æ£€æŸ¥å¤åˆ¶çŠ¶æ€</span>
</span></span><span style=display:flex><span>/usr/local/bin/check_replication_status.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 2. åœ¨ä¸»åº“åˆ›å»ºæµ‹è¯•æ•°æ®</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sshåˆ°è¿œç¨‹æœåŠ¡å™¨æ‰§è¡Œï¼š</span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo -i -u postgres psql -c &#34;CREATE TABLE test_sync AS SELECT generate_series(1,100) as id, now() as timestamp;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 3. åœ¨æœ¬åœ°éªŒè¯æ•°æ®</span>
</span></span><span style=display:flex><span>/Library/PostgreSQL/16/bin/psql -U postgres -c <span style=color:#e6db74>&#34;SELECT COUNT(*) FROM test_sync;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 4. æŸ¥çœ‹ç›‘æ§é¡µé¢ï¼ˆå¦‚æœå¯ç”¨äº†Webç›‘æ§ï¼‰</span>
</span></span><span style=display:flex><span><span style=color:#75715e># è®¿é—® http://localhost:5000</span>
</span></span></code></pre></div><h2 id=è¿™æ ·ä½ å°±æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹åˆ°æœ¬åœ°çš„-postgresql-ä¸»ä»å¤åˆ¶å¤‡ä»½æ–¹æ¡ˆ>è¿™æ ·ä½ å°±æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è¿œç¨‹åˆ°æœ¬åœ°çš„ PostgreSQL ä¸»ä»å¤åˆ¶å¤‡ä»½æ–¹æ¡ˆï¼</h2><p><a href=/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84-%E5%85%B5%E6%B3%95%E7%AF%87/>â—€ è¿”å›</a></p></div><div class="post__tags tags clearfix"><svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373.0-.74-.24-1-.5L1 8A2.853 2.853.0 01.3 7C.113 6.55.0 5.973.0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034.0 1.4.0h4.2c.373.0.95.113 1.4.3s.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5.0 100-3 1.5 1.5.0 000 3z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/postgresql/ rel=tag>postgresql</a></li></ul></div></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="wu guojun avatar" src=/img/QR.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>å…³äº wu guojun</span></div><div class=authorbox__description>åŒ—äº¬ç‰›é©¬ï¼Œé«˜çº§ CVå·¥ç¨‹ç‹®</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=/%E5%90%8E%E7%AB%AF%E6%9E%B6%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93-PostgreSQL%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84/ rel=prev><span class=post-nav__caption>Â«&#8201;ä¸Šä¸€ç¯‡</span><p class=post-nav__post-title>å…¸ç±ç¯‡</p></a></div></nav></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__links><a class=footer__link href=/post/about/>ä¸ªäººç®€å†-ä¸­æ–‡</a> | <a class=footer__link href=/post/about-en/>ä¸ªäººç®€å†-è‹±æ–‡</a></div><div class=footer__copyright>&copy; 2025 è¡¥æ¼ç –åŒ .
<span class=footer__copyright-credits><a href=# rel="nofollow noopener" target=_blank>å·¦é”®å³é¼ è¿é˜´é˜³ï¼ŒæŒ–å±±å¡«æµ·ç å‡ è¡Œã€‚</a> <a href=# rel="nofollow noopener" target=_blank>äººæµ·æµ®æ²‰çš†è¿‡å®¢ï¼Œæˆ‘æ˜¯äººé—´è¡¥æ¼åŒ ã€‚</a></span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=/js/quiz.js></script><script src=/js/ai-quiz.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>